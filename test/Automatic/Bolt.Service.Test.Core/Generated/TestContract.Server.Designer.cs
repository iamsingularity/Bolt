//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.

//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using Bolt.Server;
using Bolt.Service.Test.Core;
using Bolt.Service.Test.Core.Parameters;
using Owin;


namespace Bolt.Service.Test.Core
{
    public partial class TestContractInvoker : Bolt.Server.ContractInvoker<Bolt.Service.Test.Core.TestContractDescriptor>
    {
        public override void Init()
        {
            AddAction(Descriptor.SimpleMethodWithSimpleArguments, TestContract_SimpleMethodWithSimpleArguments);
            AddAction(Descriptor.SimpleMethod, TestContract_SimpleMethod);
            AddAction(Descriptor.SimpleMethodExAsync, TestContract_SimpleMethodExAsync);
            AddAction(Descriptor.SimpleMethodWithCancellation, TestContract_SimpleMethodWithCancellation);
            AddAction(Descriptor.ComplexFunction, TestContract_ComplexFunction);
            AddAction(Descriptor.SimpleMethodWithComplexParameter, TestContractInner_SimpleMethodWithComplexParameter);
            AddAction(Descriptor.SimpleFunction, TestContractInner_SimpleFunction);
            AddAction(Descriptor.FunctionReturningHugeData, TestContractInner_FunctionReturningHugeData);
            AddAction(Descriptor.MethodTakingHugeData, TestContractInner_MethodTakingHugeData);
            AddAction(Descriptor.MethodWithNotSerializableType, TestContractInner_MethodWithNotSerializableType);
            AddAction(Descriptor.FunctionWithNotSerializableType, TestContractInner_FunctionWithNotSerializableType);
            AddAction(Descriptor.SimpleAsyncFunction, TestContractInner_SimpleAsyncFunction);
            AddAction(Descriptor.MethodWithManyArguments, TestContractInner_MethodWithManyArguments);
            AddAction(Descriptor.ThisMethodShouldBeExcluded, ExcludedContract_ThisMethodShouldBeExcluded);

            base.Init();
        }
        protected virtual async Task TestContract_SimpleMethodWithSimpleArguments(Bolt.Server.ServerActionContext context)
        {
            var parameters = await DataHandler.ReadParametersAsync<SimpleMethodWithSimpleArgumentsParameters>(context);
            var instance = InstanceProvider.GetInstance<ITestContract>(context);
            try
            {
                instance.SimpleMethodWithSimpleArguments(parameters.Val);
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContract_SimpleMethod(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContract>(context);
            try
            {
                instance.SimpleMethod();
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContract_SimpleMethodExAsync(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContract>(context);
            try
            {
                await instance.SimpleMethodExAsync();
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContract_SimpleMethodWithCancellation(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContract>(context);
            try
            {
                instance.SimpleMethodWithCancellation(context.CallCancelled);
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContract_ComplexFunction(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContract>(context);
            try
            {
                var result = instance.ComplexFunction();
                await ResponseHandler.Handle(context, result);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_SimpleMethodWithComplexParameter(Bolt.Server.ServerActionContext context)
        {
            var parameters = await DataHandler.ReadParametersAsync<SimpleMethodWithComplexParameterParameters>(context);
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                instance.SimpleMethodWithComplexParameter(parameters.CompositeType);
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_SimpleFunction(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                var result = instance.SimpleFunction();
                await ResponseHandler.Handle(context, result);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_FunctionReturningHugeData(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                var result = instance.FunctionReturningHugeData();
                await ResponseHandler.Handle(context, result);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_MethodTakingHugeData(Bolt.Server.ServerActionContext context)
        {
            var parameters = await DataHandler.ReadParametersAsync<MethodTakingHugeDataParameters>(context);
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                instance.MethodTakingHugeData(parameters.Arg);
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_MethodWithNotSerializableType(Bolt.Server.ServerActionContext context)
        {
            var parameters = await DataHandler.ReadParametersAsync<MethodWithNotSerializableTypeParameters>(context);
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                instance.MethodWithNotSerializableType(parameters.Arg);
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_FunctionWithNotSerializableType(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                var result = instance.FunctionWithNotSerializableType();
                await ResponseHandler.Handle(context, result);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_SimpleAsyncFunction(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                var result = await instance.SimpleAsyncFunction();
                await ResponseHandler.Handle(context, result);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task TestContractInner_MethodWithManyArguments(Bolt.Server.ServerActionContext context)
        {
            var parameters = await DataHandler.ReadParametersAsync<MethodWithManyArgumentsParameters>(context);
            var instance = InstanceProvider.GetInstance<ITestContractInner>(context);
            try
            {
                instance.MethodWithManyArguments(parameters.Arg1, parameters.Arg2, parameters.Time);
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }

        protected virtual async Task ExcludedContract_ThisMethodShouldBeExcluded(Bolt.Server.ServerActionContext context)
        {
            var instance = InstanceProvider.GetInstance<IExcludedContract>(context);
            try
            {
                instance.ThisMethodShouldBeExcluded();
                await ResponseHandler.Handle(context);
                InstanceProvider.ReleaseInstance(context, instance, null);
            }
            catch (Exception e)
            {
                InstanceProvider.ReleaseInstance(context, instance, e);
                throw;
            }
        }
    }
}

namespace Bolt.Server
{
    public static partial class TestContractInvokerExtensions
    {
        public static IAppBuilder UseTestContract(this IAppBuilder app, Bolt.Service.Test.Core.ITestContract instance)
        {
            return app.UseTestContract(new StaticInstanceProvider(instance));
        }

        public static IAppBuilder UseTestContract<TImplementation>(this IAppBuilder app) where TImplementation: Bolt.Service.Test.Core.ITestContract, new()
        {
            return app.UseTestContract(new InstanceProvider<TImplementation>());
        }

        public static IAppBuilder UseStateFullTestContract<TImplementation>(this IAppBuilder app, ActionDescriptor initInstanceAction, ActionDescriptor releaseInstanceAction, string sessionHeader = null, TimeSpan? sessionTimeout = null) where TImplementation: Bolt.Service.Test.Core.ITestContract, new()
        {
            return app.UseTestContract(new StateFullInstanceProvider<TImplementation>(initInstanceAction, releaseInstanceAction, sessionHeader ?? app.GetBolt().Configuration.SessionHeader, sessionTimeout ?? app.GetBolt().Configuration.StateFullInstanceLifetime));
        }

        public static IAppBuilder UseTestContract(this IAppBuilder app, IInstanceProvider instanceProvider)
        {
            var boltExecutor = app.GetBolt();
            var invoker = new Bolt.Service.Test.Core.TestContractInvoker();
            invoker.Init(boltExecutor.Configuration);
            invoker.InstanceProvider = instanceProvider;
            boltExecutor.Add(invoker);

            return app;
        }
    }
}

